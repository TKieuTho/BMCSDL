
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết Lớp</title>
    <link rel="stylesheet" href="<%= BASE_URL %>/css/style.css">
    <link rel="stylesheet" href="<%= BASE_URL %>/css/classDetail.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-info">
                <h1>Danh sách Sinh viên Lớp: <%= classId %></h1>
                <p class="welcome-text">Xin chào, <%= staffName %></p>
            </div>
            <div class="header-buttons">
                <button onclick="showAddStudentForm()" class="action-btn">Thêm Sinh viên</button>
                <a href="<%= BASE_URL %>/class/<%= classId %>/grades" class="btn">Xem bảng điểm</a>
                <a href="<%= BASE_URL %>/class" class="back-btn">Quay lại</a>
                <a href="<%= BASE_URL %>/auth/logout" class="logout-btn">Đăng xuất</a>
            </div>
        </header>

        <% if (typeof error !== 'undefined' && error) { %>
            <div class="error-message"><%= error %></div>
        <% } %>

        <div class="students-table">
            <% if (students.length === 0) { %>
                <p class="no-data">Chưa có sinh viên trong lớp</p>
            <% } else { %>
                <table>
                    <thead>
                        <tr>
                            <th>Mã SV</th>
                            <th>Họ tên</th>
                            <th>Ngày sinh</th>
                            <th>Địa chỉ</th>
                            <th>Tên đăng nhập</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% students.forEach(function(student) { %>
                            <tr>
                                <td><%= student.MASV %></td>
                                <td><%= student.HOTEN %></td>
                                <td><%= new Date(student.NGAYSINH).toLocaleDateString('vi-VN') %></td>
                                <td><%= student.DIACHI || 'N/A' %></td>
                                <td><%= student.TENDN %></td>
                                <td>
                                    <button class="edit-btn" 
                                        data-masv="<%= student.MASV %>"
                                        data-hoten="<%= student.HOTEN %>"
                                        data-ngaysinh="<%= new Date(student.NGAYSINH).toISOString().split('T')[0] %>"
                                        data-diachi="<%= student.DIACHI || '' %>"
                                        onclick="showEditStudent(this)">Sửa</button>
                                    <button onclick="showAddGrade('<%= student.MASV %>')" class="grade-btn">Nhập điểm</button>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            <% } %>
        </div>

        <!-- Add Student Form -->
        <div id="addStudentForm" class="modal" style="display: none;">
            <div class="modal-content">
                <h2>Thêm Sinh viên Mới</h2>
                <form action="<%= BASE_URL %>/class/<%= classId %>/add-student" method="POST">
                    <div class="form-group">
                        <label for="masv">Mã sinh viên:</label>
                        <input type="text" id="masv" name="masv" required>
                    </div>
                    <div class="form-group">
                        <label for="hoten">Họ tên:</label>
                        <input type="text" id="hoten" name="hoten" required>
                    </div>
                    <div class="form-group">
                        <label for="ngaysinh">Ngày sinh:</label>
                        <input type="date" id="ngaysinh" name="ngaysinh" required>
                    </div>
                    <div class="form-group">
                        <label for="diachi">Địa chỉ:</label>
                        <input type="text" id="diachi" name="diachi">
                    </div>
                    <div class="form-group">
                        <label for="tendn">Tên đăng nhập:</label>
                        <input type="text" id="tendn" name="tendn" required>
                    </div>
                    <div class="form-group">
                        <label for="matkhau">Mật khẩu:</label>
                        <input type="password" id="matkhau" name="matkhau" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">Thêm</button>
                        <button type="button" onclick="hideAddStudentForm()" class="cancel-btn">Hủy</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Student Form -->
        <div id="editStudentForm" class="modal" style="display: none;">
            <div class="modal-content">
                <h2>Cập nhật Thông tin Sinh viên</h2>
                <form id="editStudentFormContent" action="<%= BASE_URL %>/class/student/<%= classId %>/update" method="POST">
                    <input type="hidden" id="edit_masv" name="masv">
                    <input type="hidden" id="edit_malop" name="malop" value="<%= classId %>">
                    <div class="form-group">
                        <label for="edit_hoten">Họ tên:</label>
                        <input type="text" id="edit_hoten" name="hoten" required>
                    </div>
                    <div class="form-group">
                        <label for="edit_ngaysinh">Ngày sinh:</label>
                        <input type="date" id="edit_ngaysinh" name="ngaysinh" required>
                    </div>
                    <div class="form-group">
                        <label for="edit_diachi">Địa chỉ:</label>
                        <input type="text" id="edit_diachi" name="diachi">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">Cập nhật</button>
                        <button type="button" onclick="hideEditStudentForm()" class="cancel-btn">Hủy</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Grade Form -->
        <div id="addGradeForm" class="modal" style="display: none;">
            <div class="modal-content">
                <h2>Nhập điểm</h2>
                <form id="addGradeFormContent" onsubmit="return submitGrade(event)">
                    <input type="hidden" id="grade_masv" name="masv">
                    <input type="hidden" id="grade_malop" name="malop" value="<%= classId %>">
                    <div class="form-group">
                        <label for="mahp">Học phần:</label>
                        <select id="mahp" name="mahp" required>
                            <option value="">Chọn học phần</option>
                            <% subjects.forEach(function(subject) { %>
                                <option value="<%= subject.MAHP %>"><%= subject.TENHP %></option>
                            <% }); %>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="diemthi">Điểm thi:</label>
                        <input type="number" id="diemthi" name="diemthi" step="0.1" min="0" max="10" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">Lưu điểm</button>
                        <button type="button" onclick="hideAddGradeForm()" class="cancel-btn">Hủy</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function showAddStudentForm() {
            document.getElementById('addStudentForm').style.display = 'block';
        }

        function hideAddStudentForm() {
            document.getElementById('addStudentForm').style.display = 'none';
        }

        function showEditStudent(button) {
            const form = document.getElementById('editStudentForm');
            document.getElementById('edit_masv').value = button.dataset.masv;
            document.getElementById('edit_hoten').value = button.dataset.hoten;
            document.getElementById('edit_ngaysinh').value = button.dataset.ngaysinh;
            document.getElementById('edit_diachi').value = button.dataset.diachi;
            form.style.display = 'block';
        }

        function hideEditStudentForm() {
            document.getElementById('editStudentForm').style.display = 'none';
        }

        function showAddGrade(masv) {
            const form = document.getElementById('addGradeForm');
            document.getElementById('grade_masv').value = masv;
            form.style.display = 'block';
        }

        function hideAddGradeForm() {
            document.getElementById('addGradeForm').style.display = 'none';
        }

        function submitGrade(event) {
            event.preventDefault();
            const form = event.target;
            const studentId = document.getElementById('grade_masv').value;
            const formData = {
                mahp: form.querySelector('[name="mahp"]').value,
                diemthi: parseFloat(form.querySelector('[name="diemthi"]').value),
                malop: form.querySelector('[name="malop"]').value
            };

            fetch(`<%= BASE_URL %>/grades/student/${studentId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Cập nhật điểm thành công!');
                    hideAddGradeForm();
                    // Reload the page to show updated grades
                    window.location.reload();
                } else {
                    alert(data.error || 'Có lỗi xảy ra khi cập nhật điểm');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi cập nhật điểm. Vui lòng thử lại.');
            });

            return false;
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let modal of modals) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            }
        }

        // Update the form submission handler
        document.getElementById('editStudentFormContent').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                // Create a regular object from form data
                const formData = new URLSearchParams(new FormData(this)).toString();
                
                const response = await fetch(this.action, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });

                const result = await response.json();
                console.log('Server response:', result); // Debug log

                if (result.success) {
                    // Hide the form
                    hideEditStudentForm();
                    
                    // Update the table with new data
                    const tbody = document.querySelector('.students-table tbody');
                    if (result.data && result.data.students && result.data.students.length > 0) {
                        tbody.innerHTML = result.data.students.map(student => `
                            <tr>
                                <td>${student.MASV}</td>
                                <td>${student.HOTEN}</td>
                                <td>${new Date(student.NGAYSINH).toLocaleDateString('vi-VN')}</td>
                                <td>${student.DIACHI || 'N/A'}</td>
                                <td>${student.TENDN || ''}</td>
                                <td>
                                    <button class="edit-btn" 
                                        data-masv="${student.MASV}"
                                        data-hoten="${student.HOTEN}"
                                        data-ngaysinh="${new Date(student.NGAYSINH).toISOString().split('T')[0]}"
                                        data-diachi="${student.DIACHI || ''}"
                                        onclick="showEditStudent(this)">Sửa</button>
                                    <button onclick="showAddGrade('${student.MASV}')" class="grade-btn">Nhập điểm</button>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        console.log('No students data received'); // Debug log
                        tbody.innerHTML = '<tr><td colspan="6">Không có sinh viên nào trong lớp</td></tr>';
                    }

                    // Show success message
                    const message = document.createElement('div');
                    message.className = 'success-message';
                    message.textContent = result.message || 'Cập nhật thành công';
                    document.querySelector('.container').insertBefore(message, document.querySelector('.students-table'));
                    setTimeout(() => message.remove(), 3000);

                } else {
                    throw new Error(result.error || 'Cập nhật thất bại');
                }
            } catch (error) {
                console.error('Error:', error);
                // Show error message
                const message = document.createElement('div');
                message.className = 'error-message';
                message.textContent = error.message || 'Không thể cập nhật thông tin sinh viên';
                document.querySelector('.container').insertBefore(message, document.querySelector('.students-table'));
                setTimeout(() => message.remove(), 3000);
            }
        });
    </script>
</body>
</html> 