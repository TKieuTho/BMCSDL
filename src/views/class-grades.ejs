<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng điểm Lớp <%= classId %> - Hệ thống Quản lý Sinh viên</title>
    <link rel="stylesheet" href="<%= BASE_URL %>/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-info">
                <h1>Bảng điểm Lớp: <%= classId %></h1>
                <p class="welcome-text">Xin chào, <%= staffName %></p>
            </div>
            <div class="header-buttons">
                <a href="<%= BASE_URL %>/class/<%= classId %>" class="btn back-btn">Quay lại</a>
                <a href="<%= BASE_URL %>/auth/logout" class="btn logout-btn">Đăng xuất</a>
            </div>
        </header>

        <% if (typeof error !== 'undefined' && error) { %>
            <div class="error-message"><%= error %></div>
        <% } %>

        <% if (!students || students.length === 0) { %>
            <form action="<%= BASE_URL %>/class/<%= classId %>/grades" method="POST">
                <label for="password">Nhập mật khẩu để xem bảng điểm:</label>
                <input type="password" id="password" name="password" required>
                <button type="submit" class="btn">Xác thực</button>
            </form>
        <% } else { %>
            <div class="grades-container">
                <div style="margin-bottom: 20px; padding: 10px; background: #f5f5f5;">
                    <h3>Debug Information:</h3>
                    <p>Number of students: <%= students.length %></p>
                    <p>First student data: <%= JSON.stringify(students[0]) %></p>
                    <p>Subjects: <%= JSON.stringify(subjects) %></p>
                </div>
                
                <div class="grades-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Mã SV</th>
                                <th>Họ tên</th>
                                <% subjects.forEach(subject => { %>
                                    <th><%= subject.TENHP %></th>
                                <% }); %>
                                <th>Điểm TB</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% students.forEach(student => { %>
                                <tr>
                                    <td><%= student.MASV %></td>
                                    <td><%= student.HOTEN %></td>
                                    <% subjects.forEach(subject => { %>
                                        <td>
                                            <% 
                                                const grade = student.grades && student.grades[subject.MAHP];
                                                if (grade !== undefined && grade !== null) {
                                                    const color = grade >= 5 ? '#2ecc71' : '#e74c3c';
                                                    const gradeText = grade.toFixed(1);
                                            %>
                                                <span class="grade-value" style="color: <%= color %>"><%= gradeText %></span>
                                            <% } else { %>
                                                <span class="grade-value" style="color: #95a5a6">-</span>
                                            <% } %>
                                        </td>
                                    <% }); %>
                                    <td>
                                        <% 
                                            const grades = student.grades ? Object.values(student.grades).filter(g => g !== null && g !== undefined) : [];
                                            const avgGrade = grades.length > 0 
                                                ? (grades.reduce((sum, g) => sum + g, 0) / grades.length).toFixed(1)
                                                : '-';
                                            const color = avgGrade !== '-' && avgGrade >= 5 ? '#2ecc71' : '#e74c3c';
                                        %>
                                        <span class="grade-value" style="color: <%= color %>"><%= avgGrade %></span>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            </div>
        <% } %>
    </div>
</body>
</html>